import google.generativeai as genai
import logging
import asyncio
import os

logger = logging.getLogger('CryptoBot')

class AIService:
    def __init__(self, api_key, proxy=None):
        if proxy:
            os.environ['http_proxy'] = proxy
            os.environ['https_proxy'] = proxy
        genai.configure(api_key=api_key)
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ—é –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—É—é –º–æ–¥–µ–ª—å
        self.model = genai.GenerativeModel('models/gemini-2.5-flash')

    async def rewrite_news(self, text):
        # –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–´–ô –ü–†–û–ú–ü–¢ (–°–¢–ò–õ–¨: BLOOMBERG/–†–ë–ö)
        prompt = f'''–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ–±–æ–∑—Ä–µ–≤–∞—Ç–µ–ª—å. –¢–≤–æ—è —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ‚Äî –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–Ω—ã–µ —Ä—ã–Ω–∫–∏.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞: –ø—Ä–æ—á–∏—Ç–∞—Ç—å –Ω–æ–≤–æ—Å—Ç—å –∏ –Ω–∞–ø–∏—Å–∞—Ç—å –∫—Ä–∞—Ç–∫—É—é –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫—É—é —Å–≤–æ–¥–∫—É –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.

–°–¢–ò–õ–¨ –ò –¢–û–ù:
- –î–µ–ª–æ–≤–æ–π, —Å–¥–µ—Ä–∂–∞–Ω–Ω—ã–π, –æ–±—ä–µ–∫—Ç–∏–≤–Ω—ã–π.
- –ò–∑–±–µ–≥–∞–π —Å–ª–µ–Ω–≥–∞ ("—Ç—É–∑–µ–º—É–Ω", "—Ö–æ–º—è–∫–∏") –∏ —Ñ–∞–º–∏–ª—å—è—Ä–Ω–æ—Å—Ç–∏.
- –ò–∑–±–µ–≥–∞–π –∫–∞–Ω—Ü–µ–ª—è—Ä–∏–∑–º–∞ –∏ –∑–∞—É–º–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤. –ü–∏—à–∏ —Ç–∞–∫, —á—Ç–æ–±—ã –ø–æ–Ω—è–ª –∏–Ω–≤–µ—Å—Ç–æ—Ä —Å—Ä–µ–¥–Ω–µ–≥–æ —É—Ä–æ–≤–Ω—è.

–°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê:
1. üì∞ –ó–ê–ì–û–õ–û–í–û–ö: –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π, –æ—Ç—Ä–∞–∂–∞—é—â–∏–π —Å—É—Ç—å —Å–æ–±—ã—Ç–∏—è.
2. üìä –°–£–¢–¨: 2-3 –∞–±–∑–∞—Ü–∞. –ö—Ç–æ, —á—Ç–æ —Å–¥–µ–ª–∞–ª, –ø—Ä–∏—á–∏–Ω—ã –∏ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è. –¶–∏—Ñ—Ä—ã –∏ —Ñ–∞–∫—Ç—ã.
3. üí° –ö–û–ù–¢–ï–ö–°–¢ (–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ): –û–¥–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å –≤—ã–≤–æ–¥–æ–º –∏–ª–∏ –≤–ª–∏—è–Ω–∏–µ–º –Ω–∞ —Ä—ã–Ω–æ–∫.

–§–û–¢–û-–ó–ê–ü–†–û–° (–û–ß–ï–ù–¨ –í–ê–ñ–ù–û):
–í –∫–æ–Ω—Ü–µ –æ—Ç–≤–µ—Ç–∞ –¥–æ–±–∞–≤—å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å ||| –∏ –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ñ–æ—Ç–æ –Ω–∞ Unsplash.
–ó–ê–ü–†–û–° –î–û–õ–ñ–ï–ù –ë–´–¢–¨ –û–ü–ò–°–ê–ù–ò–ï–ú –§–ò–ó–ò–ß–ï–°–ö–û–ì–û –û–ë–™–ï–ö–¢–ê, –∞ –Ω–µ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–µ–π.
–ü–ª–æ—Ö–æ: "inflation fear"
–•–æ—Ä–æ—à–æ: "red stock chart graph on monitor screen", "stack of us dollar bills", "bitcoin coin on wooden table"

–ò–°–•–û–î–ù–´–ô –¢–ï–ö–°–¢:\n{text}'''
        try:
            response = await asyncio.to_thread(
                self.model.generate_content, prompt)
            return response.text
        except Exception as e:
            logger.error(f'AI –û—à–∏–±–∫–∞: {e}')
            return None